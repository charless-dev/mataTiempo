<!DOCTYPE html>
<html>
<head>
	<title>Hello world</title>
	<meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
	
	<link rel="stylesheet" type="text/css" href="css/main.css">

	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</head>
<script src="/socket.io/socket.io.js"></script>

<body>

	<div class="container container-alerta">
		<br>
		<div class="row">	
			<div class="col-xs-12 text-center">
				<img src="img/alerta.gif" style="max-width: 50px;">
				<img src="img/alerta.gif" style="max-width: 50px;">
				<img src="img/alerta.gif" style="max-width: 50px;">
				<img src="img/alerta.gif" style="max-width: 50px;">
				<img src="img/alerta.gif" style="max-width: 50px;">
			</div>						
		</div>						
		<br>
	</div>

	<div class="container container-info">
		<br><br>
		<div class="row">	
			<div class="col-xs-4 col-xs-offset-4 text-center">
				<form>
					<div class="form-group">
						<input id="name" type="text" name="name" class="form-control" placeholder="Nombre">
					</div>
					<div class="form-group">
						<input id="frase" type="text" name="frase" class="form-control" placeholder="Frase si ganas">
					</div>
					<button id="button" type="button" class="btn btn-default" name="button" onclick="setUsername()">A voliar!</button>
				</form>
			</div>						
		</div>						
	</div>
	<div class="container container-avatars">
		<br><br><br>
		<div class="row">
			<div class="col-xs-2"><div style="background-image: url(img/p1.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p2.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p3.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p4.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p5.gif); transform: scaleX(-1);" class="avatar"></div></div>			
			<div class="col-xs-2"><div style="background-image: url(img/p6.gif);  transform: scaleX(-1);" class="avatar"></div></div>			
		</div>
		<div class="row">
			<div class="col-xs-2"><div style="background-image: url(img/p7.gif);  transform: scaleX(-1);" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p8.gif); transform: scaleX(-1);" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p9.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p10.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p11.gif);  transform: scaleX(-1);" class="avatar"></div></div>			
			<div class="col-xs-2"><div style="background-image: url(img/p12.gif)" class="avatar"></div></div>						
		</div>
		<div class="row">
			<div class="col-xs-2"><div style="background-image: url(img/p13.gif); transform: scaleX(-1);" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p14.gif);  transform: scaleX(-1);" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p15.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p16.gif);  transform: scaleX(-1);" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p17.gif)" class="avatar"></div></div>			
			<div class="col-xs-2"><div style="background-image: url(img/p18.gif);  transform: scaleX(-1);" class="avatar"></div></div>						
		</div>
		<div class="row">
			<div class="col-xs-2"><div style="background-image: url(img/p19.gif);  transform: scaleX(-1);" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p20.gif);  transform: scaleX(-1);" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p21.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p22.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p23.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p24.gif)" class="avatar"></div></div>
		</div>
		<div class="row">						
			<div class="col-xs-2"><div style="background-image: url(img/p25.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p26.gif)" class="avatar"></div></div>
			<div class="col-xs-2"><div style="background-image: url(img/p27.gif)" class="avatar"></div></div>
		</div>
	</div>

	<script>

	//var socket = io();
	var socket = io.connect('http://172.87.5.29:3000',{'forceNew':true});
	var avatar;
	var user;
	var idsocket;
	var meta;
	var avatarW;
	var frase;		

	function seleccionarAvatar() {
		$(".avatar").removeClass('selected');
		$(this).addClass('selected');
		avatar = $(this).clone().wrap('<p>').parent().html();
	}
	$(".avatar").on( "click", seleccionarAvatar );

	function setUsername(){
		var nombreUsusario = document.getElementById('name').value;				
		frase = document.getElementById('frase').value;		
		console.log(frase);
		console.log(avatar+nombreUsusario);
		socket.emit('setUsername', {nombre:nombreUsusario, pic:avatar});
		outIntro();
	};

	socket.on('userExists', function(data){
		document.getElementById('error-container').innerHTML = data;
	});

	socket.on('addUser', function(data){
		user = data.username;
		idsocket = data.id;
		pic = data.avatar;
		if(user){
			$( "body" ).append( '<div id="'+idsocket+'" class="usuario-cont"> <span class="nombre">'+user+'</span>'+pic+'<span class="meta"></span></div>' );
		}
	});

	socket.on('userSet', function(data){
		user = data.username;
		idsocket = data.id;
		$(".container-alerta").css('display','block');
		window.onkeydown = mover;
		window.onkeyup = parar;
		meta = $("#"+idsocket+" .meta");
		avatarW = $("#"+idsocket+" .avatar");
	});

	function outIntro() {
		$(".container-info, .container-avatars").slideUp("slow");
	}

	socket.on('usuarioDesconectado',function(data){
		if(user){
			document.getElementById(data.id).remove();
		}
	});

	var fired = false;

	function mover(e) {
		if (e.keyCode == 39 || e.keyCode == 32){
			if(!fired) {
				fired = true;
				socket.emit('moverUser');        	
			}
		}									
	}

	function parar(e) {
		if (e.keyCode == 39 || e.keyCode == 32){
			fired = false;
		}
		if (collision(avatarW, meta)) {
			window.onkeydown = null;
			window.onkeyup = null;
			socket.emit('validarGano');
		}
	}	

	function collision($div1, $div2) {
		var x1 = $div1.offset().left;
		var y1 = $div1.offset().top;
		var h1 = $div1.outerHeight(true);
		var w1 = $div1.outerWidth(true);
		var b1 = y1 + h1;
		var r1 = x1 + w1;
		var x2 = $div2.offset().left;
		var y2 = $div2.offset().top;
		var h2 = $div2.outerHeight(true);
		var w2 = $div2.outerWidth(true);
		var b2 = y2 + h2;
		var r2 = x2 + w2;

		if (b1 < y2 || y1 > b2 || r1 < x2 || x1 > r2) return false;
		return true;
	}

	var usuariollegada;
	socket.on('mostrarGano', function(data){
		usuariollegada = data.idelement;
		$( "<div class='usuario-gano text-center'><img src='img/win1.gif' style='width: 100%;'><h3>"+frase+"</h3><img src='img/win1.gif' style='width: 100%;'></div>" ).appendTo( "#"+usuariollegada);
	});
	var numl;
	socket.on('mostrarPerdio', function(data){
		usuariollegada = data.idelement;
		numl = data.num;
		$( "<div class='usuario-gano text-center'><span style='width: 185px; height:93px; background-position: center; background-size: cover; background-repeat: no-repeat;background-image: url(img/loser"+numl+".gif); display: inline-block;' ></span></div>" ).appendTo( "#"+usuariollegada);
	});

	socket.on('moverTodo', function(data){
		$("#"+data.idelement+" .avatar").css( "bottom", "+=5" );
	});

</script>

</body>
</html>